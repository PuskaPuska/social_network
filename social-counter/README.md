# social-counter сервис счетчиков
- Сервис хранит число непрочитанных сообщений
- на сервис предполагается большая нагрузка на чтение
- Для хранения использует Redis
- консистентность между счетчиком и реальным числом непрочитанных сообщений по паттерну SAGA


## Последовательность транзакций
- Компенсирующая - отменяет изменение сделанное локальной транзакцией
- Компенсируемая – ее необходимо компенсировать (отменить) в случае, 
  если последующие за ней транзакции завершаются неудачей
- Поворотная - определяет успешность саги. Если она выполняется успешно, 
  то сага гарантированно дойдет до конца.
- Повторяемая – идет после поворотной и гарантированно завершается успехом 


### Логика создания чатов и сообщений (живет в social-chat)
1) Создание чата
- checkIfChatExist()
- insertChatRecord() - (removeChatRecord() - Компенсирующая)
- incChatCounter() - (decChatCounter() - Компенсирующая)
 
2) Сохранение сообщения
- checkIfChatExist()
- insertMessageRecord() - (removeMessageRecord() - Компенсирующая)
- incMessageCounter() - (decMessageCounter() - Компенсирующая)


## Архитектура
- Взаимодействие сервисов на общей [схеме](../README.md)
- Сервисы общаются по GRPC - [proto контракт](./src/main/resources/proto/CounterGrpcService.proto)
- для храниения счетчиков используется редис – [docker-compose.yml](./docker-compose.yml)
- инкремент счетчиков происходит на редисе – [INCR](https://redis.io/commands/incr)
  - если ключ еще не задан, редис записывает и возвращает 0
